"use strict";!function(){var a=angular.module("civApp",["ngAnimate","ngResource","ngRoute","ngSanitize","ngMessages","ui.bootstrap","ngTouch","ab-base64","angular-growl","ngTable","nya.bootstrap.select"]);a.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/list.html",controller:"GameListController as gameListCtrl",resolve:{games:["GameService",function(a){return a.getAllGames()}]}}).when("/game/:id",{templateUrl:"views/game.html",controller:"ChatController as chatCtrl",resolve:{chatList:["GameService","$route",function(a,b){return a.getChatList(b.current.params.id)}]}}).when("/help",{templateUrl:"views/help.html"}).when("/about",{templateUrl:"views/about.html"}).when("/logout",{redirectTo:"/"}).when("/endgame",{redirectTo:"/"}).otherwise({templateUrl:"404.html"})}]),a.config(["growlProvider",function(a){a.globalTimeToLive(7e3),a.globalDisableCountDown(!1),a.globalPosition("top-center"),a.onlyUniqueMessages(!0)}]).constant("BASE_URL","https://civilization-boardgame.herokuapp.com/api")}(),function(a){a.config(["$provide",function(a){a.provider("GameService",["BASE_URL",function(a){var b={},c={},d={},e={},f=a+"/game/";this.$get=["$http","$log","growl","$location","$q","formEncode","currentUser",function(a,g,h,i,j,k,l){var m=function(b){if(!b)return j.reject("No game to create");var c={name:b.name,type:b.type,numOfPlayers:b.numOfPlayers,color:b.color};return a.post(f,c).success(function(a,b,c){h.success("Game created!");var d=c("Location");if(d){var e=_.last(d.split("/"));e&&i.path("/game/"+e)}return a}).error(function(a){return h.error("Could not create game"),a})},n=function(b){return b&&b.id?a.post(f+b.id+"/join").then(function(a){return a.data}):j.reject("No game to join")},o=function(c){var e=f+c,g=c+l.profile.id;return d[g]=!0,a.get(e).then(function(a){return b[g]=a.data,d[g]=!1,a.data})},p=function(a){var c=a+l.profile.id;return b[c]?b[c]:void(d[c]||o(a))},q=function(){return a.get(f).then(function(a){return a.data})},r=function(b,c){var d=f+b+"/undo/"+c;a.put(d).success(function(a){return h.success("Undo initiated!"),a}).success(function(a){return o(b),a}).error(function(a,b){return h.error(400===b?"Undo already initiated":"Could not initiate undo for unknown reason"),a})},s=function(b){if(!b)return j.reject("No gameid");var c=f+b+"/techs";return a.get(c).then(function(a){return g.info("Got all available techs"),a.data})},t=function(b,c){var d=f+b+"/vote/"+c+"/yes";a.put(d).success(function(a){return h.success("You voted yes!"),a}).success(function(a){return o(b),a}).error(function(a,b){return h.error(412===b?"Could not register vote. Nothing to vote on":"Could not vote for unknown reason"),a})},u=function(b,c){var d=f+b+"/vote/"+c+"/no";a.put(d).success(function(a){return h.success("You voted no!"),a}).success(function(a){return o(b),a}).error(function(a,b){return h.error(412===b?"Could not register vote. Nothing to vote on":"Could not vote for unknown reason"),a})},v=function(b){if(!b)return j.reject("No gameid");var c=f+b+"/chat/";return a.get(c).then(function(a){return a.data})},w=function(b,c){if(!b||!c)return j.reject("No gameid or chat message");var d=f+b+"/chat/",e={headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}},g=k({message:encodeURIComponent(c)});return a.post(d,g,e).then(function(a){return a.data})},x=function(a){var b=a+l.profile.id;if(!e[b])return c[b]?c[b]:y(a)},y=function(b){if(!b)return j.reject("No gameid");var d=b+l.profile.id,g=f+b+"/players";return e[d]=!0,a.get(g,{cache:!0}).then(function(a){return c[d]=a.data,e[d]=!1,a.data})},z=function(b){return b?a["delete"](f+b).then(function(a){return h.info("Game has ended"),a.data}):j.reject("No gameid")},A=function(b){return b?a.post(f+b+"/withdraw").then(function(a){return h.info("You have withdrawn from the game"),a.data}):j.reject("No gameid")},B=function(b,c){if(!c||!b)return j.reject("No maplink or gameid");var d=f+b+"/map/",e={headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}},g=k({link:encodeURIComponent(c)});return a.post(d,g,e).then(function(a){return a.data})},C=function(b,c){if(!c||!b)return j.reject("No assetlink or gameid");var d=f+b+"/asset/",e={headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}},g=k({link:encodeURIComponent(c)});return a.post(d,g,e).then(function(a){return a.data})};return{getAllGames:q,getGameById:p,fetchGameByIdFromServer:o,joinGame:n,createGame:m,undoDraw:r,getAvailableTechs:s,voteYes:t,voteNo:u,getChatList:v,chat:w,players:x,fetchPlayersFromServer:y,endGame:z,withdrawFromGame:A,updateMapLink:B,updateAssetLink:C}}]}])}])}(angular.module("civApp")),function(a){a.factory("DrawService",["$http","$q","$log","growl","currentUser","BASE_URL","GameService","Util",function(a,b,c,d,e,f,g,h){var i=f+"/draw/",j=function(b,e){var f=i+b+"/battle";return a({url:f,method:"PUT",params:{numOfUnits:e}}).success(function(a){return a.length>0?d.success("Units added to battlehand"):d.warning("You have no units to draw"),a}).success(function(a){return g.fetchGameByIdFromServer(b),a}).error(function(a){return c.error(a),d.error("Could not add units to battlehand for unknown reason"),a})},k=function(b){var e=i+b+"/battle/barbarians";return a.put(e).success(function(a){return d.success("Barbarians have been drawn"),a}).success(function(a){return g.fetchGameByIdFromServer(b),a}).error(function(a){return c.error(a),d.error(412===a.status?"Cannot draw more barbarians until the others are discarded":"Unable to draw barbarian units"),a})},l=function(c){var e=i+c+"/battle/discard/barbarians";return a.post(e).success(function(a){return d.success("Barbarians discarded"),a}).success(function(a){return g.fetchGameByIdFromServer(c),a}).error(function(){return d.error("Could not discard barbarians for unknown reason"),b.reject()})},m=function(b){var c=i+b+"/battlehand/reveal";return a.put(c).success(function(a){return d.success("Units are revealed and discarded from hand"),a}).success(function(a){return g.fetchGameByIdFromServer(b),a}).error(function(){d.error("Units could not be revealed and discarded")})},n=function(b,c){var e=i+b+"/"+c;return a.post(e).success(function(a){return d.success("Item successfully drawn"),a}).success(function(a){return g.fetchGameByIdFromServer(b),a}).error(function(a,b){d.error(410===b?"There are no more "+c+" to draw!":"Item could not be drawn")})},o=function(b,c,e){var f=i+b+"/"+c+"/loot/"+e;return a.post(f).success(function(a){var b=h.nextElement(a);return d.success("Item "+b.name+" looted by another player"),a}).success(function(a){return g.fetchGameByIdFromServer(b),a}).error(function(a){return d.error("Item could not be lootet"),a})};return{drawUnitsFromHand:j,revealHand:m,discardBarbarians:l,drawBarbarians:k,drawItem:n,loot:o}}])}(angular.module("civApp")),function(a){a.factory("PlayerService",["$http","$q","$log","growl","currentUser","BASE_URL","GameService","Util",function(a,b,c,d,e,f,g,h){var i=f+"/player/",j=function(e,f){if(!e||!f)return b.reject("No gameId or logid");var j=i+e+"/item/reveal",k={name:h.nextElement(f).name,ownerId:h.nextElement(f).ownerId,sheetName:h.nextElement(f).sheetName,pbfId:e};c.info("Before calling put, json is ",angular.toJson(k));var l={headers:{"Content-Type":"application/json"}};return a.put(j,k,l).success(function(a){return d.success("Item revealed"),a}).success(function(a){return g.fetchGameByIdFromServer(e),a}).error(function(){d.error("Item could not be revealed")})},k=function(c,e){if(!c||!e)return b.reject("No gameId or logid");var f=i+c+"/tech/reveal/"+e;a.put(f).success(function(a){return d.success("Research revealed!"),a}).success(function(a){return g.fetchGameByIdFromServer(c),a}).error(function(a){return d.error("Could not reveal tech"),a})},l=function(e,f){if(!e||!f)return b.reject("No gameId or item");var j=i+e+"/item/discard",k={name:h.nextElement(f).name,ownerId:h.nextElement(f).ownerId,sheetName:h.nextElement(f).sheetName,pbfId:e};c.info("Before calling post, json is ",angular.toJson(k));var l={headers:{"Content-Type":"application/json"}};a.post(j,k,l).success(function(a){return d.success("Item discarded"),a}).success(function(a){return g.fetchGameByIdFromServer(e),a}).error(function(a){return d.error("Item could not be discarded"),a})},m=function(c){if(!c)return b.reject("No gameId");var e=i+c+"/endturn";return a.post(e).success(function(a){return d.success("Turn ended"),a}).success(function(a){return g.fetchGameByIdFromServer(c),a}).error(function(a){return d.error("Could not end turn"),a})},n=function(f){if(!f)return b.reject("No gameId");var g=i+f+"/tech/"+e.profile.id;return a.get(g).then(function(a){return a.data},function(a){return c.error(a),d.error("Could not get chosen techs"),b.reject()})},o=function(c,e){if(!c||!e)return b.reject("No gameId or tech");var f=i+c+"/tech/choose";return a({url:f,method:"POST",params:{name:e.tech.name}}).success(function(a){return d.success("Tech chosen successfully"),a}).success(function(a){return g.fetchGameByIdFromServer(c),a}).error(function(a){return d.error("Could not choose tech"),a})},p=function(e,f){if(!e||!f)return b.reject("No gameId or tech");var h=i+e+"/tech/remove";return a({url:h,method:"DELETE",params:{name:f}}).success(function(a){return d.success("Tech removed successfully"),a}).success(function(a){return g.fetchGameByIdFromServer(e),a}).error(function(a){return c.error(a),d.error("Could not remove tech"),a})},q=function(e,f){if(!e||!f)return b.reject("Couldn't get gameId or item");var h=i+e+"/trade/",j={name:f.name,sheetName:f.sheetName,pbfId:e,ownerId:f.ownerId};c.info("Before calling post, json is ",angular.toJson(j));var k={headers:{"Content-Type":"application/json"}};a.post(h,j,k).success(function(a){return d.success("Item sent to another player"),a}).success(function(a){return g.fetchGameByIdFromServer(e),a}).error(function(a){return d.error("Item could not be sent to another player"),a})};return{revealItem:j,revealTech:k,discardItem:l,endTurn:m,selectTech:o,getChosenTechs:n,removeTech:p,trade:q}}])}(angular.module("civApp")),function(a){var b=function(a){var b=0,c=function(c){return b+=1,a.when(c)},d=function(c){return b-=1,a.reject(c)},e=function(c){return b-=1,a.when(c)},f=function(c){return b-=1,a.reject(c)},g=function(){return b};return{request:c,response:e,requestError:d,responseError:f,getRequestCount:g}};b.$inject=["$q"],a.factory("requestCounter",b),a.config(["$httpProvider",function(a){a.interceptors.push("requestCounter")}])}(angular.module("civApp")),function(a){var b=function(a){var b=a.localStorage,c=function(a,c){c=angular.toJson(c),b.setItem(a,c)},d=function(a){var c=b.getItem(a);return c&&(c=angular.fromJson(c)),c},e=function(a){b.removeItem(a)};return{add:c,get:d,remove:e}};b.$inject=["$window"],a.factory("localStorage",b)}(angular.module("civApp")),function(a){var b=function(){return function(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&").replace(/%20/g,"+")}};a.factory("formEncode",b)}(angular.module("civApp")),function(a){var b=function(){var a="/auth",b="";this.$get=["$q","$location",function(c,d){return{responseError:function(e){return 401===e.status&&(b=d.path(),d.path(a)),c.reject(e)},redirectPreLogin:function(){b?(d.path(b),b=""):d.path("/")}}}]};a.provider("loginRedirect",b),a.config(["$httpProvider",function(a){a.interceptors.push("loginRedirect")}])}(angular.module("civApp")),function(a){var b="authorizationEncoded",c=function(a){var c=function(){a.add(b,f)},d=function(){a.remove(b)},e=function(){var c={username:"",password:"",id:"",authorizationEncoded:"",get loggedIn(){return this.authorizationEncoded?!0:!1}},d=a.get(b);return d&&(c.username=d.username,c.password=d.password,c.id=d.id,c.authorizationEncoded=d.authorizationEncoded),c},f=e();return{save:c,remove:d,profile:f}};c.$inject=["localStorage"],a.factory("currentUser",c)}(angular.module("civApp")),function(a){var b=function(a,b){return{request:function(c){return a.profile.authorizationEncoded&&(c.headers.Authorization="Basic "+a.profile.authorizationEncoded),b.when(c)}}};b.$inject=["currentUser","$q"],a.factory("addToken",b),a.config(["$httpProvider",function(a){a.interceptors.push("addToken")}])}(angular.module("civApp")),function(a){var b=function(){this.$get=function(a,b,c,d,e,f){var g=e+"/auth",h=function(a,b){return function(e){return c.profile.username=a,c.profile.id=e.data.id,c.profile.authorizationEncoded=d.encode(a+":"+b),c.save(),a}},i=function(c,d){var e={headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}},i=b({username:encodeURIComponent(c),password:encodeURIComponent(d),grant_type:"password"});return a.post(g+"/login",i,e).then(h(c,d),function(){f.error("Invalid login")})},j=function(){c.profile.username="",c.profile.password="",c.profile.authorizationEncoded="",c.profile.id="",c.remove()},k=function(c){var e={headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}},h=b({username:encodeURIComponent(c.username),password:encodeURIComponent(d.encode(c.password)),email:encodeURIComponent(c.email)});return a.post(g+"/register",h,e).success(function(a){return f.success("User created"),a}).success(function(a){return i(c.username,c.password),a}).error(function(a){return f.error("Could not register"),a})};return{login:i,logout:j,register:k}}};a.config(["$provide",function(a){a.provider("basicauth",[b])}])}(angular.module("civApp")),function(a){var b=function(){var a=function(a){if(a){var b=Object.keys(a);if(b&&b.length>0)return a[b[0]]}return a},b=function(a){var b="https://docs.google.com/presentation/d/",c="/embed?start=false&loop=false&delayms=3000";return b+a+c},c=function(a){var b="https://docs.google.com/spreadsheets/d/",c="/pubhtml?widget=true&amp;headers=false";return b+a+c};return{nextElement:a,mapLink:b,assetLink:c}};a.factory("Util",b)}(angular.module("civApp")),function(a){var b=function(){this.value={show:!1,showEndGame:!1},this.getValue=function(){return this.value},this.setShowValue=function(a){this.value.show=a},this.setShowEndGameValue=function(a){this.value.showEndGame=a}};a.service("GameOption",b)}(angular.module("civApp")),function(a){var b=function(a){return{restrict:"EAC",transclude:!0,scope:{},template:"<ng-transclude ng-show='requestCount'></ng-transclude>",link:function(b){b.$watch(function(){return a.getRequestCount()},function(a){b.requestCount=a})}}};b.$inject=["requestCounter"],a.directive("workSpinner",b)}(angular.module("civApp")),angular.module("civApp").directive("ngReallyClick",[function(){return{restrict:"A",link:function(a,b,c){b.bind("click",function(){var b=c.ngReallyMessage;b&&confirm(b)&&a.$apply(c.ngReallyClick)})}}}]),angular.module("civApp").directive("uniqueUsername",["$http","BASE_URL",function(a,b){return{require:"ngModel",link:function(c,d,e,f){c.busy=!1,c.$watch(e.ngModel,function(d){if(f.$setValidity("isTaken",!0),f.$setValidity("invalidChars",!0),d){var e=b+"/auth/register/check/username";c.busy=!0,a.post(e,{name:d}).success(function(){c.busy=!1}).error(function(a){a.isTaken?f.$setValidity("isTaken",!1):a.invalidChars&&f.$setValidity("invalidChars",!1),c.busy=!1})}})}}}]),angular.module("civApp").directive("uniqueGamename",["$http","BASE_URL",function(a,b){return{require:"ngModel",link:function(c,d,e,f){c.busy=!1,c.$watch(e.ngModel,function(d){if(f.$setValidity("isTaken",!0),f.$setValidity("invalidChars",!0),d){var e=b+"/game/check/gamename";c.busy=!0,a.post(e,{name:d}).success(function(){c.busy=!1}).error(function(a){a.isTaken?f.$setValidity("isTaken",!1):a.invalidChars&&f.$setValidity("invalidChars",!1),c.busy=!1})}})}}}]),angular.module("civApp").directive("match",[function(){return{require:"ngModel",link:function(a,b,c,d){a.$watch("["+c.ngModel+", "+c.match+"]",function(a){d.$setValidity("match",a[0]===a[1])},!0)}}}]),function(a){var b=function(a,b,c,d,e,f){var g=this;g.isUserPlaying=function(a){if(a)for(var b=0;b<a.length;b++){var c=a[b];if(c&&c.username===g.user.username)return!0}return!1},g.joinGame=function(a){var d=c.joinGame(a).then(function(a){return g.game=a,f.userHasAccess=a.player&&a.player.username===g.user.username,g.yourTurn=a.player&&a.player.yourTurn,a});return b.debug("User wants to join game with nr "+a.id),d},g.showMyGames=function(){f.filterContent=f.onlyMyGames.value?g.user.username:""},g.openCreateNewGame=function(a){var d=e.open({templateUrl:"createNewGame.html",controller:"RegisterController as registerCtrl",size:a});d.result.then(function(a){a&&(b.info(a.name),b.info(a.type),b.info(a.numOfPlayers),b.info(a.color),c.createGame(a))},function(){})};var h=function(){g.user=d.profile,g.games=[],g.finishedGames=[],f.onlyMyGames={},_.forEach(a,function(a){a.active?g.games.push(a):g.finishedGames.push(a)}),b.info("Got games")};h()};a.controller("GameListController",["games","$log","GameService","currentUser","$modal","$scope",b])}(angular.module("civApp")),function(a){var b=function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){return j.userHasAccess&&a&&a.draw&&a.log.indexOf("drew")>-1}var o=this;j.$watch(function(){return c.getGameById(o.gameId)},function(a){if(a){var b=a;j.currentGame=b,j.currentGame.mapLink=m.trustAsResourceUrl(j.currentGame.mapLink?f.mapLink(j.currentGame.mapLink):"https://docs.google.com/presentation/d/1hgP0f6hj4-lU6ysdOb02gd7oC5gXo8zAAke4RhgIt54/embed?start=false&loop=false&delayms=3000"),j.currentGame.assetLink=m.trustAsResourceUrl(j.currentGame.assetLink?f.assetLink(j.currentGame.assetLink):"https://docs.google.com/spreadsheets/d/10-syTLb2i2NdB8T_alH9KeyzT8FTlBK6Csmc_Hjjir8/pubhtml?widget=true&amp;headers=false");var c=b.player&&b.player.username===o.user.username&&b.active;return j.userHasAccess=c,g.setShowValue(c),g.setShowEndGameValue(c&&b.player.gameCreator),b.active&&(_.forEach(b.publicLogs,function(a){return j.canVote(a)?(k.warning("An undo was requested which needs your vote"),!1):void 0}),o.yourTurn=b.player&&b.player.yourTurn,o.yourTurn&&k.info("<strong>It's your turn! Press end turn when you are done!</strong>")),o.tableParams.reload(),b}}),o.endTurn=function(){a.info("Ending turn"),d.endTurn(o.gameId)},j.canInitiateUndo=function(a){return n(a)&&!a.draw.undo},j.initiateUndo=function(a){c.undoDraw(b.id,a)},j.canVote=function(a){var b=!1;if(n(a)&&a.draw.undo){var c=a.draw.undo.votes;for(var d in c)if(d===o.user.id)return!1;return!0}return b},j.openModalVote=function(b,d){var e=l.open({templateUrl:"modalVote.html",controller:"VoteController",size:b,resolve:{logToUndo:function(){return d}}});e.result.then(function(b){a.info("Vote was "+b.vote+" and logid is "+b.id),b.vote?c.voteYes(o.gameId,b.id):c.voteNo(o.gameId,b.id)},function(){a.info("Modal dismissed at: "+new Date)})},o.updateMapLink=function(){var d=j.currentGame.newMapLink,e=new RegExp("^https://docs.google.com/presentation/d/","i");if(!e.test(d))return void k.error("Wrong URL. Must start with https://docs.google.com/presentation/d/");var g=c.updateMapLink(b.id,d).then(function(b){if(b){var c=f.mapLink(b.msg);a.info("Map link is "+c),j.currentGame.mapLink=m.trustAsResourceUrl(c)}});return g},o.updateAssetLink=function(){var d=j.currentGame.newAssetLink,e=new RegExp("^https://docs.google.com/spreadsheets/d/","i");if(!e.test(d))return void k.error("Wrong URL. Must start with https://docs.google.com/spreadsheets/d/");var g=c.updateAssetLink(b.id,d).then(function(b){if(b){var c=f.assetLink(b.msg);a.info("Asset link is "+c),j.currentGame.assetLink=m.trustAsResourceUrl(c)}});return g},o.tableParams=new i({page:1,count:10,sorting:{created:"desc"}},{total:0,getData:function(a,b){if(!j.currentGame)return void a.reject("No game yet");var c=j.currentGame,d=_.last(c.publicLogs);d&&d.log&&(j.latestLog=d.log);var e=b.sorting()?h("orderBy")(c.publicLogs,b.orderBy()):c.publicLogs;b.total(c.publicLogs.length),a.resolve(e.slice((b.page()-1)*b.count(),b.page()*b.count()))},$scope:{$data:{},$emit:function(){}}}),o.nextElement=function(a){return f.nextElement(a)};var p=function(){o.user=e.profile,j.userHasAccess=!1,o.yourTurn=!1,o.gameId=b.id,o.GameOption=g};p()};a.controller("GameController",["$log","$routeParams","GameService","PlayerService","currentUser","Util","GameOption","$filter","ngTableParams","$scope","growl","$modal","$sce",b])}(angular.module("civApp")),function(a){var b=function(a,b,c,d,e,f,g,h){var i=this;i.GameOption=g,i.user=d.profile,i.username="",i.password="",i.user=d.profile,i.registerUsername=null,i.registerEmail=null,i.registerPassword=null,i.registerVerification=null,i.clearOptions=function(){g.setShowValue(!1),g.setShowEndGameValue(!1)},i.endGame=function(){var c=a.getGameById(b.id);c&&c.player&&c.player.gameCreator?(i.clearOptions(),a.endGame(b.id)):e.error("Only the game creator can end a game!")},i.withdrawGame=function(){var c=a.getGameById(b.id);if(c&&c.player){if(c.player.gameCreator)return void e.error("As game creator you cannot withdraw from the game. You can only end it!");c.player.username===i.user.username?(i.clearOptions(),a.withdrawFromGame(b.id)):e.error("Only player playing the game can withdraw from it!")}},i.login=function(a){a.$valid&&(c.login(i.username,i.password).then(f.redirectPreLogin),i.password="")},i.signOut=function(){c.logout()},i.openSignup=function(a){var b=h.open({templateUrl:"signup.html",controller:"RegisterController as registerCtrl",size:a});b.result.then(function(a){a&&(c.register(a),i.registerUsername=null,i.registerEmail=null,i.registerPassword=null,i.registerVerification=null)},function(){})}};a.controller("NavController",["GameService","$routeParams","basicauth","currentUser","growl","loginRedirect","GameOption","$modal",b])}(angular.module("civApp")),function(a){var b=function(a,b,c,d,e,f,g,h){var i=this;h.$watch(function(){return b.getGameById(g.id)},function(a){if(a){var b=a;i.barbarians=b.player.barbarians,i.battlehand=b.player.battlehand}});var j=function(){i.user=d.profile,i.number=3,i.barbarians=h.currentGame.player.barbarians?h.currentGame.player.barbarians:[],i.battlehand=h.currentGame.player.battlehand?h.currentGame.player.battlehand:[]};i.drawUnits=function(){return a.info("Draw "+i.number+" units"),i.number<1?void f.error("You must draw at least 1 unit"):void c.drawUnitsFromHand(g.id,i.number)},i.drawBarbarians=function(){c.drawBarbarians(g.id)},i.discardBarbarians=function(){c.discardBarbarians(g.id).then(function(){i.barbarians=[]})},i.nextElement=function(a){return e.nextElement(a)},i.revealBattlehand=function(){i.battlehand&&i.battlehand.length>0&&c.revealHand(g.id)},j()};a.controller("DrawController",["$log","GameService","DrawService","currentUser","Util","growl","$routeParams","$scope",b])}(angular.module("civApp")),function(a){var b=function(a,b,c,d,e,f,g,h,i,j,k){function l(a){a.forEach(function(a){var b=Object.keys(a)[0];"cultureI"===b||"cultureII"===b||"cultureIII"===b?n.cultureCards.push(a):"greatperson"===b?n.greatPersons.push(a):"hut"===b?n.huts.push(a):"village"===b?n.villages.push(a):"tile"===b?n.tiles.push(a):"civ"===b?n.civs.push(a):"aircraft"===b||"mounted"===b||"infantry"===b||"artillery"===b?n.units.push(a):n.items.push(a)})}function m(a){n.chosenTechs1=[],n.chosenTechs2=[],n.chosenTechs3=[],n.chosenTechs4=[],n.chosenTechs5=[],n.availableTech1=[],n.availableTech2=[],n.availableTech3=[],n.availableTech4=[],a.forEach(function(a){var b=a.tech||a;b&&(1===b.level?n.chosenTechs1.push(b):2===b.level?n.chosenTechs2.push(b):3===b.level?n.chosenTechs3.push(b):4===b.level?n.chosenTechs4.push(b):5===b.level&&n.chosenTechs5.push(b))});for(var b=0;b<5-n.chosenTechs1.length;b++)n.availableTech1.push(b);for(var c=0;c<4-n.chosenTechs2.length;c++)n.availableTech2.push(c);for(var d=0;d<3-n.chosenTechs3.length;d++)n.availableTech3.push(d);for(var e=0;e<2-n.chosenTechs4.length;e++)n.availableTech4.push(e)}var n=this;n.nextElement=function(a){return f.nextElement(a)},n.itemName=function(a){var b=Object.keys(a);return b&&b.length>-1?_.capitalize(b[0]):a},n.revealItem=function(c){var d=j.revealItem(b.id,c);a.info("Revealed item, response is "+d)},n.discardItem=function(c){a.info("Discard item "+c.name),j.discardItem(b.id,c)},i.$watch(function(){return c.getGameById(b.id)},function(a){if(a){var b=a;return n.techsChosen=b.player.techsChosen,m(n.techsChosen),n.civs=[],n.cultureCards=[],n.greatPersons=[],n.huts=[],n.villages=[],n.tiles=[],n.units=[],n.items=[],l(b.player.items),n.tablePrivateLog.reload(),b}}),n.drawItem=function(a){a&&d.drawItem(b.id,a)},n.selectTech=function(){i.selectedTech.tech&&j.selectTech(b.id,i.selectedTech.tech).then(function(){c.getAvailableTechs(b.id).then(function(a){n.allAvailableTechs=a})})},n.removeTech=function(d){a.info("Removing tech "+d),j.removeTech(b.id,d).then(function(){c.getAvailableTechs(b.id).then(function(a){n.allAvailableTechs=a})})},n.canRevealTech=function(a){return i.userHasAccess&&a&&a.draw&&a.draw.hidden&&a.log.indexOf("researched")>-1},n.revealTechFromLog=function(a){j.revealTech(b.id,a)};var o=(c.getAvailableTechs(b.id).then(function(a){n.allAvailableTechs=a}),j.getChosenTechs(b.id).then(function(a){n.chosenTechs=a,m(n.chosenTechs)}),c.players(b.id));n.openModalTrade=function(c,d){if(d){var e=k.open({templateUrl:"modalTrade.html",controller:"TradeController as tradeCtrl",size:c,resolve:{players:function(){return o},item:function(){return d}}});e.result.then(function(a){j.trade(b.id,a)},function(){a.info("Modal dismissed at: "+new Date)})}},n.openModalLoot=function(c,e){if(e){var f=k.open({templateUrl:"modalLoot.html",controller:"LootController as lootCtrl",size:c,resolve:{players:function(){return o},sheetName:function(){return e}}});f.result.then(function(a){d.loot(b.id,a.sheetName,a.playerId)},function(){a.info("Modal dismissed at: "+new Date)})}},n.tablePrivateLog=new h({page:1,count:10,sorting:{created:"desc"}},{total:0,getData:function(a,b){if(!i.currentGame)return void a.reject("No game yet");var c=i.currentGame,d=b.sorting()?g("orderBy")(c.privateLogs,b.orderBy()):c.privateLogs;b.total(c.privateLogs.length),a.resolve(d.slice((b.page()-1)*b.count(),b.page()*b.count()))},$scope:{$data:{},$emit:function(){}}});var p=function(){n.user=e.profile,n.allAvailableTechs=[],i.privateLogCollapse=!1,i.itemCollapse=!1,i.gpCollapse=!1,i.unitCollapse=!1,i.cultureCardsCollapse=!1,i.civCollapse=!1,i.hutsCollapse=!1,i.villagesCollapse=!1,i.selectedTech={},n.yourTurn=!1,n.items=[],n.techsChosen=[],n.civs=[],n.cultureCards=[],n.greatPersons=[],n.huts=[],n.villages=[],n.tiles=[],n.units=[]};p()};a.controller("UserItemController",["$log","$routeParams","GameService","DrawService","currentUser","Util","$filter","ngTableParams","$scope","PlayerService","$modal",b])}(angular.module("civApp")),angular.module("civApp").controller("VoteController",["$scope","$modalInstance","$log","logToUndo",function(a,b,c,d){a.voteOk=function(){var a={id:d.id,vote:!0};b.close(a)},a.voteNok=function(){var a={id:d.id,vote:!1};b.close(a)},a.voteCancel=function(){b.dismiss("cancel")}}]),angular.module("civApp").controller("RegisterController",["$scope","$modalInstance","$log","growl",function(a,b,c,d){var e=this;e.gameTypes=[{label:"Base Game",value:"BASE",disabled:!0},{label:"Fame and Fortune (FAF)",value:"FAF",disabled:!0},{label:"Wisdom and Warfare (WAW) & Fame and Fortune",value:"WAW",disabled:!1},{label:"Dawn of Civilization",value:"DOC",disabled:!0}],e.selectedGametype=e.gameTypes[2],a.createGameOk=function(){if(e.selectedGametype&&"WAW"!==e.selectedGametype.value)return void d.error("We only support Wisdom and Warfare the time being");var a={name:e.gamename,type:e.selectedGametype.value,numOfPlayers:e.numOfPlayers,color:e.color};b.close(a)},a.registerOk=function(){if(!a.verification||!a.password&&a.password!==a.verification)return void d.error("Passwords did not match");if(!a.securityQuestion||"WRITING"!==a.securityQuestion.toUpperCase())return void d.error("Wrong answer to the security question");var c={username:e.registerUsername,email:e.registerEmail,password:a.password};b.close(c)},a.registerCancel=function(){b.dismiss("cancel")}}]),function(a){var b=function(a,b,c,d,e,f,g){var h=this;h.chat=function(){h.chatMessage&&d.chat(f.id,h.chatMessage).then(function(a){var b=a;b&&(b.message=a.message,g.chatList.unshift(b),h.chatMessage="")})};var i=function(){g.chatList=a};i()};a.controller("ChatController",["chatList","$log","currentUser","GameService","growl","$routeParams","$scope",b])}(angular.module("civApp")),angular.module("civApp").controller("TradeController",["players","item","currentUser","$scope","$modalInstance",function(a,b,c,d,e){var f=this;f.players=a,f.item=b,f.ok=function(){b.ownerId=f.playerTradeChosen.playerId,e.close(b)},f.cancel=function(){e.dismiss("cancel")}}]),angular.module("civApp").controller("LootController",["players","sheetName","currentUser","$scope","$modalInstance",function(a,b,c,d,e){var f=this;f.players=a,f.sheetName=b,f.ok=function(){e.close({playerId:f.playerLootChosen.playerId,sheetName:b})},f.cancel=function(){e.dismiss("cancel")}}]);